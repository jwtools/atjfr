name: Build, Sign, and Publish Firefox Extension

on:
  push:
    branches:
      - main

jobs:
  build-sign-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install web-ext tool
        run: npm install -g web-ext

      - name: Build and Sign Extension
        run: |
          cd extension
          web-ext sign --api-key=${{ secrets.AMO_JWT_ISSUER }} --api-secret=${{ secrets.AMO_JWT_SECRET }} --timeout 300

      - name: Prepare GitHub Pages Deployment
        run: |
          mkdir -p docs
          cp extension/web-ext-artifacts/*.xpi docs/atjfr.xpi
          
          LATEST_VERSION=$(ls extension/web-ext-artifacts/*.xpi | grep -o '[0-9]\+\.[0-9]\+' | head -1)
          
          echo '{
            "addons": {
              "atjfr-ff@barraud.io": {
                "updates": [
                  {
                    "version": "'$LATEST_VERSION'",
                    "update_link": "https://jwtools.github.io/atjfr/atjfr.xpi"
                  }
                ]
              }
            }
          }' > docs/updates.json

          # G√©n√©rer une page HTML avec un lien vers la derni√®re version
          echo '<!DOCTYPE html>
          <html lang="fr">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Extension Firefox Priv√©e</title>
          </head>
          <body>
              <h1>Extension Firefox Priv√©e</h1>
              <p>Derni√®re version : <strong>'$LATEST_VERSION'</strong></p>
              <p><a href="extension.xpi" download="atjfr.xpi">üì• T√©l√©charger l‚Äôextension</a></p>
              <p>Pour l‚Äôinstaller, ouvrez <code>about:addons</code> dans Firefox et s√©lectionnez le fichier t√©l√©charg√©.</p>
          </body>
          </html>' > docs/index.html

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: main
          folder: docs
